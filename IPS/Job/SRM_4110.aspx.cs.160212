using ClosedXML.Excel;
using Microsoft.Reporting.WebForms;
using System;
using System.Collections;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using System.Web;
using System.Web.Script.Serialization;
using System.Web.Services;
using Excel = Microsoft.Office.Interop.Excel;


public partial class Job_SRM_4110 : System.Web.UI.Page
{
    protected void Page_Load(object sender, EventArgs e)
    {
    }
    
    #region Print() : DB의 Data를 통해 출력물 Create.

    /// <summary>
    /// Print() : DB의 Data를 통해 출력물 Create.
    ///     : input
    ///         - DATA : Query and Argument / Option
    ///     : output 
    ///         - success : 출력물 파일 정보
    ///         - else : entityProcessed (string)
    /// </summary>
    [WebMethod]
    public static string Print(cRetrieveData DATA)
    {
        #region check Argument.

        // check Argument.
        //
        if (string.IsNullOrEmpty(DATA.getQuery()))
        {
            return new JavaScriptSerializer().Serialize(
                        new entityProcessed<string>(
                                codeProcessed.ERR_PARAM,
                                "잘못된 호출입니다.")
                    );  
        }

        #endregion

        string strReturn = string.Empty;

        SqlConnection objCon = null;
        SqlCommand objCmd = null;
        SqlDataReader objDr = null;
        try
        {
            #region connect to DB.

            //  connect to DB.
            //
            try
            {
                objCon = new SqlConnection(
                                    ConfigurationManager.ConnectionStrings["PLMDB"].ConnectionString);
                objCon.Open();
            }
            catch (SqlException ex)
            {
                throw new Exception(
                    new JavaScriptSerializer().Serialize(
                        new entityProcessed<string>(
                            codeProcessed.ERR_SQL,
                            "Database에 연결할 수 없습니다.\n- " + ex.Message)
                        )
                    );
            }
            catch (Exception ex)
            {
                throw new Exception(
                    new JavaScriptSerializer().Serialize(
                        new entityProcessed<string>(
                            codeProcessed.ERR_PROCESS,
                            "Database 연결 중에 오류가 발생하였습니다.\n- " + ex.Message)
                        )
                    );
            }

            #endregion

            #region get Query from DB.

            string strSQL = string.Empty;
            string strBody = string.Empty;

            try
            {
                strSQL = string.Format(@"
                            SELECT qry_sel AS QUERY_SELECT
                            FROM ZQUERY
                            WHERE qry_id = '{0}'",
                            DATA.getQuery());
                objCmd = new SqlCommand(strSQL, objCon);
                objDr = objCmd.ExecuteReader();
                
                if (objDr.Read())
                {
                    strBody = objDr["QUERY_SELECT"].ToString();
                    objDr.Close();
                }
                else
                {
                    throw new Exception(
                        "관련 Query를 찾을 수 없습니다.");
                }
            }
            catch (SqlException ex)
            {
                throw new Exception(
                    new JavaScriptSerializer().Serialize(
                        new entityProcessed<string>(
                            codeProcessed.ERR_SQL,
                            "Query 조회에 실패하였습니다.\n- " + ex.Message)
                        )
                    );
            }
            catch (Exception ex)
            {
                throw new Exception(
                    new JavaScriptSerializer().Serialize(
                        new entityProcessed<string>(
                            codeProcessed.ERR_PROCESS,
                            "Query 조회에 실패하였습니다.\n- " + ex.Message)
                        )
                    );
            }

            #endregion

            #region create Query.

            if (DATA.getArgument().getSize() > 0)
            {
                #region get Argument from DB.

                Hashtable tblSelect = new Hashtable();
                try
                {
                    strSQL = string.Format(@"
                                SELECT
                                    arg_id AS ARG_ID,
                                    arg_tp AS ARG_TYPE,
                                    arg_qry AS ARG_QUERY
                                FROM ZQUERY_ARG
                                WHERE qry_id = '{0}'",
                                DATA.getQuery()
                                );
                    objCmd.CommandText = strSQL;
                    objDr = objCmd.ExecuteReader();

                    while (objDr.Read())
                    {
                        tblSelect.Add(
                            objDr["ARG_ID"].ToString(),
                            new cDBArgument(
                                objDr["ARG_TYPE"].ToString(),
                                objDr["ARG_QUERY"].ToString())
                            );
                    }
                    objDr.Close();
                }
                catch (SqlException ex)
                {
                    throw new Exception(
                        new JavaScriptSerializer().Serialize(
                            new entityProcessed<string>(
                                codeProcessed.ERR_SQL,
                                "Query Argument 조회에 실패하였습니다.\n- " + ex.Message)
                            )
                        );
                }
                catch (Exception ex)
                {
                    throw new Exception(
                        new JavaScriptSerializer().Serialize(
                            new entityProcessed<string>(
                                codeProcessed.ERR_PROCESS,
                                "Query Argument 조회에 실패하였습니다.\n- " + ex.Message)
                            )
                        );
                }

                #endregion

                #region bind Argument to Query.

                try
                {
                    for (int iAry = 0; iAry < DATA.getArgument().getSize(); iAry++)
                    {
                        string strArg = DATA.ARGUMENT.NAME[iAry];
                        cDBArgument objArg = (cDBArgument)tblSelect[strArg];
                        if (objArg == null)
                        {
                            throw new Exception(
                                strArg + " - 관련 Argument를 찾을 수 없습니다.");
                        }
                        strBody = objArg.convertWhere(
                                            strBody,
                                            DATA.getQuery(),
                                            strArg,
                                            HttpUtility.UrlDecode(DATA.ARGUMENT.VALUE[iAry])
                                        );
                    }
                }
                catch (Exception ex)
                {
                    throw new Exception(
                        new JavaScriptSerializer().Serialize(
                            new entityProcessed<string>(
                                    codeProcessed.ERR_PROCESS,
                                    "Query 생성에 실패하였습니다.\n- " + ex.Message)
                            )
                        );
                }

                #endregion
            }

            #endregion

            #region prepare Office object.

            string strPrint = DATA.getOption("PRINT");
            string strPage = DATA.getOption("PAGE");
            string strUser = DATA.getOption("USER");
            string strKey = DATA.getOption("KEY");
            string strTitle = DATA.getOption("TITLE");
            string strRows = DATA.getOption("ROWS");
            string sToday = DateTime.Now.ToString("yyyyMMdd");

            string sFileIdSrc = (strTitle == "납품서") ? "DeliveryS" : "ItemLabelA";
            string sFileIdTrg = sFileIdSrc + "_" + strUser + "_" + strKey;
            string sFileNmTrg = sToday + "/" + sFileIdTrg + "." + (strPrint.ToUpper().Equals("PDF") ? "pdf" : "xlsx");
            string strRoot = HttpContext.Current.Server.MapPath("~/");
            string strSource = strRoot + "Report/" + strPage + "/" + sFileIdSrc + ".xlsx";
            if (!System.IO.Directory.Exists(strRoot + "Report/" + strPage + "/" + sToday)) System.IO.Directory.CreateDirectory(strRoot + "Report/" + strPage + "/" + sToday);
            string strTarget = strRoot + "Report/" + strPage + "/" + sToday + "/" + sFileIdTrg;
            object objMissing = Type.Missing;
            object varMissing = System.Reflection.Missing.Value;

            XLWorkbook objWorkBook;
            IXLWorksheet objWorkSheet, objWorkSheet2;
            IXLRange objRange;

            try
            {
                if (System.IO.File.Exists(strTarget + ".xlsx")) System.IO.File.Delete(strTarget + ".xlsx");
                System.IO.File.Copy(strSource, strTarget + ".xlsx");
                objWorkBook = new XLWorkbook(strTarget + ".xlsx");
                objWorkSheet = objWorkBook.Worksheet(1);
            }
            catch (Exception ex)
            {
                throw new Exception(
                    new JavaScriptSerializer().Serialize(
                        new entityProcessed<string>(
                            codeProcessed.ERR_PROCESS,
                            "Office 설정 중에 오류가 발생하였습니다.\n- " + ex.Message)
                        )
                    );
            }

            #endregion

            #region process Query & set to Print.

            try
            {
                // Sorting 적용
                string strOrder = "\n" + "ORDER BY {0} {1}";
                string strSortCol = string.IsNullOrEmpty(DATA.getOption("SORT_COLUMNS")) ? "dlv_seq" : DATA.getOption("SORT_COLUMNS");
                string strSortOrd = string.IsNullOrEmpty(DATA.getOption("SORT_ORDER")) ? "asc" : DATA.getOption("SORT_ORDER");
                strBody += "\n" + string.Format(strOrder, strSortCol, strSortOrd);

                objCmd.CommandText = strBody;
                objDr = objCmd.ExecuteReader();

                if (strTitle == "납품서")
                {
                    int iStart = 7;
                    int iRow = iStart; // refer to Proto file.
                    decimal dPurQty = 0, dDlvQty = 0, dUnitPrice = 0, dAmount = 0;
                    bool bHeader = true;

                    while (objDr.Read())
                    {
                        if (bHeader)
                        {
                            objWorkSheet.Cell(3, 9).SetValue<string>((objDr["barcode"].ToString() == "" ? "" : "*" + objDr["barcode"].ToString() + "*"));   // Barcode
                            objWorkSheet.Cell(2, 4).SetValue<string>(objDr["supp_nm2"].ToString());                                                         // 공급처
                            objWorkSheet.Cell(3, 4).SetValue<string>(objDr["dlv_date"].ToString());                                                         // 납품일
                            objWorkSheet.Cell(4, 4).SetValue<string>(objDr["dlv_loc_nm"].ToString());                                                       // 사업부
                            bHeader = false;
                        }

                        objWorkSheet.Cell(iRow, 2).Value = iRow - 6;                                // 순번
                        objWorkSheet.Cell(iRow, 3).SetValue<string>(objDr["item_cd"].ToString());   // 품목코드
                        objWorkSheet.Cell(iRow, 5).SetValue<string>(objDr["item_nm"].ToString());   // 품명
                        objWorkSheet.Cell(iRow, 9).SetValue<string>(objDr["item_spec"].ToString()); // 규격
                        objWorkSheet.Cell(iRow, 12).SetValue<string>(objDr["pur_no"].ToString());   // 발주번호
                        objWorkSheet.Cell(iRow, 14).SetValue<string>(objDr["proj_no"].ToString());  // Tracking No.(Project No.)
                        objWorkSheet.Cell(iRow, 16).SetValue<string>(objDr["pur_unit"].ToString()); // 단위
                        objWorkSheet.Cell(iRow, 17).Value = Convert.ToDecimal(objDr["pur_qty"]);    // 발주수량
                        objWorkSheet.Cell(iRow, 18).Value = Convert.ToDecimal(objDr["dlv_qty"]);    // 납품수량
                        objWorkSheet.Cell(iRow, 19).Value = Convert.ToDecimal(objDr["pur_price"]);  // 단가
                        objWorkSheet.Cell(iRow, 21).Value = Convert.ToDecimal(objDr["pur_amt"]);    // 금액
                        objWorkSheet.Cell(iRow, 23).SetValue<string>(objDr["req_date"].ToString()); // 납기요청일
                        //objWorkSheet.Row(iRow).Cell(17).Value = objDr["prc_cd"].ToString();             // Pallet No.
                        //objWorkSheet.Row(iRow).Cell(23).Value = objDr["consigned_yn"].ToString();       // 사급

                        objRange = objWorkSheet.Range("C" + iRow.ToString(), "D" + iRow.ToString());
                        objRange.Merge();
                        objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;

                        objRange = objWorkSheet.Range("E" + iRow.ToString(), "H" + iRow.ToString());
                        objRange.Merge();
                        objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Left;

                        objRange = objWorkSheet.Range("I" + iRow.ToString(), "K" + iRow.ToString());
                        objRange.Merge();
                        objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Left;

                        objRange = objWorkSheet.Range("L" + iRow.ToString(), "M" + iRow.ToString());
                        objRange.Merge();
                        objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;

                        objRange = objWorkSheet.Range("N" + iRow.ToString(), "O" + iRow.ToString());
                        objRange.Merge();
                        objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;

                        objRange = objWorkSheet.Range("P" + iRow.ToString(), "P" + iRow.ToString());
                        objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;

                        objRange = objWorkSheet.Range("Q" + iRow.ToString(), "R" + iRow.ToString());
                        objRange.Style.NumberFormat.Format = "#,##0_ ";

                        objRange = objWorkSheet.Range("S" + iRow.ToString(), "T" + iRow.ToString());
                        objRange.Merge();
                        objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Right;
                        objRange.Style.NumberFormat.Format = "#,##0_ ";

                        objRange = objWorkSheet.Range("U" + iRow.ToString(), "V" + iRow.ToString());
                        objRange.Merge();
                        objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Right;
                        objRange.Style.NumberFormat.Format = "#,##0_ ";

                        dPurQty += Convert.ToDecimal(objDr["pur_qty"]);
                        dDlvQty += Convert.ToDecimal(objDr["dlv_qty"]);
                        dUnitPrice += Convert.ToDecimal(objDr["pur_price"]);
                        dAmount += Convert.ToDecimal(objDr["pur_amt"]);
                        iRow++;
                    }

                    // summary -------------------------------------------------------
                    objWorkSheet.Cell(iRow, 17).Value = dPurQty;    // 발주수량
                    objWorkSheet.Cell(iRow, 18).Value = dDlvQty;    // 납품수량
                    objWorkSheet.Cell(iRow, 19).Value = dUnitPrice; // 단가
                    objWorkSheet.Cell(iRow, 21).Value = dAmount;    // 금액

                    decimal dVat = Math.Truncate(dAmount - (dAmount / Convert.ToDecimal(1.1)));
                    dAmount = dAmount - dVat;
                    string strSum = string.Format("{2} 건,  공급가액 : {0},  세액 : {1}    ", string.Format("{0:#,##0}", dAmount), string.Format("{0:#,##0}", dVat), string.Format("{0:#,##0}", iRow - iStart));
                    objWorkSheet.Cell(iRow, 2).Value = strSum;

                    objRange = objWorkSheet.Range("B" + iRow.ToString(), "W" + iRow.ToString());
                    objRange.Style.Font.Bold = true;

                    objRange = objWorkSheet.Range("B" + iRow.ToString(), "P" + iRow.ToString());
                    objRange.Merge();
                    objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Right;

                    objRange = objWorkSheet.Range("Q" + iRow.ToString(), "R" + iRow.ToString());
                    objRange.Style.NumberFormat.Format = "#,##0_ ";

                    objRange = objWorkSheet.Range("S" + iRow.ToString(), "T" + iRow.ToString());
                    objRange.Merge();
                    objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Right;
                    objRange.Style.NumberFormat.Format = "#,##0_ ";

                    objRange = objWorkSheet.Range("U" + iRow.ToString(), "V" + iRow.ToString());
                    objRange.Merge();
                    objRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Right;
                    objRange.Style.NumberFormat.Format = "#,##0_ ";
                    //----------------------------------------------------------------

                    objRange = objWorkSheet.Range("B" + iStart.ToString(), "W" + iRow.ToString());
                    objRange.Style.Border.SetInsideBorder(XLBorderStyleValues.Thin);
                    objRange.Style.Border.SetOutsideBorder(XLBorderStyleValues.Thin);
                }
                else if (strTitle == "물품라벨")
                {
                    int iRow = 1;
                    int iCell = 0;
                    int iCount = 0;
                    int iCountAll = 0;
                    //                    int iCell = 3;
                    //                    int iCount = 1;
                    bool bRead = true;
                    objWorkSheet2 = objWorkBook.Worksheet(2);   // (Excel.Worksheet)objWorkBook.Sheets[2];     //Barcode Template Sheet
                    //objWorkSheet.VPageBreaks.Add(objWorkSheet.get_Range("R1", "R1"));
                    objWorkSheet.PageSetup.AddVerticalPageBreak(18);

                    bRead = objDr.Read();
                    while (true)
                    {
                        if (bRead)
                        {
                            iCountAll++;
                            foreach (string strDlvSeq in strRows.Split(new char[] { ',' }))
                            {
                                if (strDlvSeq.Equals(objDr["dlv_seq"].ToString()))
                                {
                                    iCell += 5;
                                    iCount++;

                                    objWorkSheet2.Cell(2, iCell).SetValue<string>(objDr["item_cd"].ToString());                     //품번
                                    objWorkSheet2.Cell(3, iCell).SetValue<string>(objDr["item_nm"].ToString());                     //품목명
                                    objWorkSheet2.Cell(4, iCell).SetValue<string>(objDr["item_spec"].ToString());                   //규격
                                    objWorkSheet2.Cell(5, iCell).SetValue<string>(objDr["proj_no"].ToString() + (objDr["pallet_no"].ToString() == "" ? "" : " / " + objDr["pallet_no"].ToString()));    //Tracking / Pallet No.
                                    objWorkSheet2.Cell(6, iCell).Value = Convert.ToDecimal(objDr["dlv_qty"]);                       //수량
                                    objWorkSheet2.Cell(6, iCell + 2).SetValue<string>(objDr["dlv_date"].ToString());                //납품일자
                                    objWorkSheet2.Cell(7, iCell - 1).SetValue<string>("*" + objDr["barcoded"].ToString() + "*");    //바코드
                                    objWorkSheet2.Cell(8, iCell - 1).SetValue<string>(objDr["barcoded"].ToString() + " - " + objDr["supp_nm"].ToString());  //바코드번호 + 업체명
                                }
                            }
                        }
                        else
                        {
                            iCell += 5;
                            iCount++;
                        }
                        bRead = objDr.Read();

                        if (iCount % 3 == 0)
                        {
                            objWorkSheet2.Range("A2:Q8").CopyTo(objWorkSheet.Range("A" + iRow.ToString(), "Q" + iRow.ToString()));
                            //objWorkSheet2.Range("A2", "A8").EntireRow.Copy(objWorkSheet.get_Range(objWorkSheet.Cells[iRow, 1], objWorkSheet.Cells[iRow + 6, 1]).EntireRow);
                            if (!bRead) break;

                            if (iCountAll % 24 == 0)
                            {
                                iRow += 7;
                                //objRange = objWorkSheet.get_Range(objWorkSheet.Cells[iRow, 1], objWorkSheet.Cells[iRow, 1]);
                                //objWorkSheet.HPageBreaks.Add(objRange);
                                objWorkSheet.PageSetup.AddHorizontalPageBreak(iRow);
                            }
                            else
                            {
                                iRow += 8;
                            }

                            iCell = 0;
                            iCount = 0;

                            objWorkSheet2.Cell(2, iCell + 5).Value = "";
                            objWorkSheet2.Cell(3, iCell + 5).Value = "";
                            objWorkSheet2.Cell(4, iCell + 5).Value = "";
                            objWorkSheet2.Cell(5, iCell + 5).Value = "";
                            objWorkSheet2.Cell(6, iCell + 5).Value = "";
                            objWorkSheet2.Cell(6, iCell + 7).Value = "";
                            objWorkSheet2.Cell(7, iCell + 4).Value = "";
                            objWorkSheet2.Cell(8, iCell + 4).Value = "";

                            objWorkSheet2.Cell(2, iCell + 10).Value = "";
                            objWorkSheet2.Cell(3, iCell + 10).Value = "";
                            objWorkSheet2.Cell(4, iCell + 10).Value = "";
                            objWorkSheet2.Cell(5, iCell + 10).Value = "";
                            objWorkSheet2.Cell(6, iCell + 10).Value = "";
                            objWorkSheet2.Cell(6, iCell + 12).Value = "";
                            objWorkSheet2.Cell(7, iCell + 9).Value = "";
                            objWorkSheet2.Cell(8, iCell + 9).Value = "";

                            objWorkSheet2.Cell(2, iCell + 15).Value = "";
                            objWorkSheet2.Cell(3, iCell + 15).Value = "";
                            objWorkSheet2.Cell(4, iCell + 15).Value = "";
                            objWorkSheet2.Cell(5, iCell + 15).Value = "";
                            objWorkSheet2.Cell(6, iCell + 15).Value = "";
                            objWorkSheet2.Cell(6, iCell + 17).Value = "";
                            objWorkSheet2.Cell(7, iCell + 14).Value = "";
                            objWorkSheet2.Cell(8, iCell + 14).Value = "";
                        }
                    }
                }
                else
                {
                    DataSet dsBarcode = new DataSet1();
                    dsBarcode.Tables[0].Load(objDr);
                    objDr.Close();

                    ReportViewer rptBarcode = new ReportViewer();
                    rptBarcode.LocalReport.ReportPath = HttpContext.Current.Server.MapPath("Report.rdlc");
                    //ReportViewer1.LocalReport.ReportPath = HttpContext.Current.Server.MapPath("Report.rdlc");

                    ReportDataSource rds = new ReportDataSource();
                    rds.Name = "DataSet1";
                    rds.Value = dsBarcode.Tables[0];
                    rptBarcode.LocalReport.DataSources.Add(rds);
                    rptBarcode.LocalReport.Refresh();

                    string strReportType = "PDF";   // Excel, PDF, Image
                    Warning[] warnings;
                    string[] streamids;
                    string mimeType;
                    string encoding;
                    string extension;

                    byte[] bytes = rptBarcode.LocalReport.Render(strReportType, null, out mimeType, out encoding, out extension, out streamids, out warnings);

                    //var context = HttpContext.Current;

                    //context.Response.Clear();
                    //context.Response.ClearContent();
                    //context.Response.ClearHeaders();
                    //context.Response.ContentType = mimeType;
                    //context.Response.AddHeader("Content-Disposition", "attachment");
                    //context.Response.BinaryWrite(bytes);
                    //context.Response.Flush();
                    //context.Response.End();

                    try
                    {
                        System.IO.FileStream fs = new System.IO.FileStream(strTarget + "." + extension, System.IO.FileMode.Create);
                        //if (System.IO.File.Exists(strTarget + "." + extension)) System.IO.File.Delete(strTarget + "." + extension);
                        fs.Write(bytes, 0, bytes.Length);
                        fs.Close();

                        strReturn = new JavaScriptSerializer().Serialize(
                                        new entityProcessed<string>(codeProcessed.SUCCESS, sFileNmTrg)
                                    );

                        return strReturn;
                    }
                    catch (Exception ex)
                    {
                        throw new Exception(
                            new JavaScriptSerializer().Serialize(
                                new entityProcessed<string>(
                                    codeProcessed.ERR_PROCESS,
                                    "Print 생성 중에 오류가 발생하였습니다.\n- " + ex.Message)
                                )
                            );
                    }
                }
                objDr.Close();
            }
            catch (SqlException ex)
            {
                throw new Exception(
                    new JavaScriptSerializer().Serialize(
                        new entityProcessed<string>(
                            codeProcessed.ERR_SQL,
                            "Data 조회에 실패하였습니다.\n- " + ex.Message)
                        )
                    );
            }
            catch (Exception ex)
            {
                throw new Exception(
                    new JavaScriptSerializer().Serialize(
                        new entityProcessed<string>(
                            codeProcessed.ERR_PROCESS,
                            "Data 조회 중에 오류가 발생하였습니다.\n- " + ex.Message)
                        )
                    );
            }

            #endregion

            #region save to File.

            try
            {
                //if (System.IO.File.Exists(strTarget)) System.IO.File.Delete(strTarget);
                if (objWorkBook.Worksheets.Count > 1) objWorkBook.Worksheet(2).Delete();
                objWorkBook.Save();
                objWorkBook.Dispose();

                if (strPrint.ToUpper() != "XLS")
                {
                    strTarget = convertPDF(strTarget + ".xlsx");
                }

                strReturn = new JavaScriptSerializer().Serialize(
                                new entityProcessed<string>( codeProcessed.SUCCESS, sFileNmTrg)
                            );
            }
            catch (Exception ex)
            {
                throw new Exception(
                    new JavaScriptSerializer().Serialize(
                        new entityProcessed<string>(
                            codeProcessed.ERR_PROCESS,
                            "Print 생성 중에 오류가 발생하였습니다.\n- " + ex.Message)
                        )
                    );
            }

            #endregion
        }
        catch (Exception ex)
        {
            #region abnormal Closing.

            // abnormal Closing.
            //
            strReturn = ex.Message;

            #endregion
        }
        finally
        {
            #region release.

            // release.
            //
            if (objDr != null) objDr.Close();
            if (objCon != null) objCon.Close();

            #endregion
        }

        return strReturn;
    }

    #endregion

    public static string convertPDF(string strFile)
    {
        object varMissing = System.Reflection.Missing.Value;
        Excel.XlFixedFormatType enTarget = Excel.XlFixedFormatType.xlTypePDF;
        Excel.XlFixedFormatQuality enQuality = Excel.XlFixedFormatQuality.xlQualityMinimum;

        Excel.Application objExcel = new Excel.Application();
        objExcel.DisplayAlerts = false;
        objExcel.Visible = false;

        //string strTarget = System.IO.Path.ChangeExtension(strFile, ".pdf");
        string strTarget = System.IO.Path.Combine(System.IO.Path.GetDirectoryName(strFile), System.IO.Path.GetFileNameWithoutExtension(strFile));

        try
        {
            Excel._Workbook objTempWorkBook = objExcel.Workbooks.Open(strFile);
            Excel._Worksheet objTempWorkSheet = (Excel.Worksheet)objTempWorkBook.Sheets[1];
            if (System.IO.File.Exists(strTarget + ".pdf")) System.IO.File.Delete(strTarget + ".pdf");
            objTempWorkSheet.ExportAsFixedFormat(enTarget, strTarget, enQuality, true, true, 1, varMissing, false, varMissing);

        }
        catch (Exception ex)
        {
            throw new Exception(
                new JavaScriptSerializer().Serialize(
                    new entityProcessed<string>(
                        codeProcessed.ERR_PROCESS,
                        "PDF 생성 중에 오류가 발생하였습니다.\n- " + ex.Message)
                    )
                );
        }
        finally
        {
            if (objExcel != null)
            {
                objExcel.Workbooks.Close();
                objExcel.Quit();
                objExcel = null;

                if (objExcel != null)
                {
                    System.Diagnostics.Process[] pProcess;
                    pProcess = System.Diagnostics.Process.GetProcessesByName("Excel");
                    pProcess[0].Kill();
                }
            }

        }

        return strTarget;
    }
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~//

